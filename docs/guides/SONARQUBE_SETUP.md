# SonarQube Setup Guide

**Version:** 1.0
**Last Updated:** 2025-10-24
**Status:** Ready for Use

---

## Overview

SonarQube provides continuous code quality and security analysis for the SyncKairos project. This guide covers both local development and CI/CD integration.

---

## Quick Start (SonarCloud - Recommended)

### 1. Create SonarCloud Account

1. Go to https://sonarcloud.io
2. Sign in with GitHub
3. Authorize SonarCloud to access your repositories

### 2. Create New Project

1. Click "+" → "Analyze new project"
2. Select `Apexphere-Consultancy-Limited/synckairos`
3. Click "Set Up"
4. Choose "With GitHub Actions"

### 3. Configure GitHub Secrets

Add these secrets to your GitHub repository (Settings → Secrets → Actions):

```
SONAR_TOKEN: [Your SonarCloud token]
SONAR_HOST_URL: https://sonarcloud.io
```

**To get your token:**
1. SonarCloud → My Account → Security
2. Generate Token → Name: `GitHub Actions`
3. Copy the token

### 4. Update sonar-project.properties

```properties
# Replace with your SonarCloud organization
sonar.organization=your-org-name

# Project key (auto-generated by SonarCloud)
sonar.projectKey=your-org_synckairos
```

### 5. Push to GitHub

The GitHub Action will automatically run on push/PR!

---

## Local Development (Docker)

### 1. Start SonarQube with Docker

```bash
# Pull and run SonarQube
docker run -d --name sonarqube \
  -p 9000:9000 \
  -e SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true \
  sonarqube:latest

# Wait for SonarQube to start (2-3 minutes)
# Check logs: docker logs -f sonarqube
```

### 2. Initial Setup

1. Open http://localhost:9000
2. Login with default credentials:
   - Username: `admin`
   - Password: `admin`
3. Change password when prompted

### 3. Create Local Project

1. Click "Create Project" → "Manually"
2. Project key: `synckairos`
3. Display name: `SyncKairos`
4. Click "Set Up"

### 4. Generate Token

1. Choose "Locally"
2. Generate a token
3. Save the token securely

### 5. Run Analysis

```bash
# Set token in environment
export SONAR_TOKEN="your-token-here"

# Run tests with coverage
pnpm test:coverage

# Run SonarQube analysis
pnpm sonar:local
```

---

## Configuration

### sonar-project.properties

```properties
# Project Information
sonar.projectKey=synckairos
sonar.projectName=SyncKairos
sonar.projectVersion=2.0.0

# Source Code
sonar.sources=src
sonar.tests=tests
sonar.sourceEncoding=UTF-8

# Coverage Reports
sonar.javascript.lcov.reportPaths=coverage/lcov.info
sonar.typescript.lcov.reportPaths=coverage/lcov.info

# Exclusions
sonar.exclusions=\
  **/node_modules/**,\
  **/dist/**,\
  **/coverage/**,\
  **/*.test.ts,\
  **/*.spec.ts

# Quality Gate
sonar.qualitygate.wait=true
```

---

## GitHub Actions Integration

The workflow runs automatically on:
- Push to `main` or `feat/*` branches
- Pull requests (opened, synchronized, reopened)

### Workflow Steps

1. **Checkout code** - Fetch full history for analysis
2. **Setup Node.js** - Install Node.js 20
3. **Install dependencies** - Install with pnpm
4. **Run tests** - Generate coverage reports
5. **SonarQube Scan** - Analyze code quality
6. **Quality Gate** - Check if code meets standards

### Required Secrets

Add these to GitHub repository secrets:
- `SONAR_TOKEN` - Your SonarQube/SonarCloud token
- `SONAR_HOST_URL` - Your SonarQube URL
  - SonarCloud: `https://sonarcloud.io`
  - Self-hosted: `https://your-sonarqube-instance.com`

---

## Quality Gates

### Default Standards

- **Coverage:** > 80%
- **Duplications:** < 3%
- **Maintainability Rating:** A
- **Reliability Rating:** A
- **Security Rating:** A
- **Security Hotspots:** 100% reviewed

### Custom Rules for SyncKairos

- **Code Smells:** 0 blocking issues
- **Bugs:** 0 blocking issues
- **Vulnerabilities:** 0 blocking issues
- **Security Hotspots:** All reviewed
- **Technical Debt:** < 5% ratio

---

## Reports & Metrics

### Key Metrics Tracked

1. **Code Coverage**
   - Line coverage
   - Branch coverage
   - Uncovered lines

2. **Code Quality**
   - Code smells
   - Technical debt
   - Maintainability rating

3. **Security**
   - Vulnerabilities
   - Security hotspots
   - Security rating

4. **Reliability**
   - Bugs
   - Reliability rating

5. **Duplications**
   - Duplicated blocks
   - Duplicated lines percentage

---

## Viewing Results

### SonarCloud (Recommended)

1. Go to https://sonarcloud.io
2. Navigate to your project
3. View dashboard with all metrics

### Local SonarQube

1. Go to http://localhost:9000
2. Click on "SyncKairos" project
3. View comprehensive dashboard

### GitHub

1. Check PR comments for quality gate status
2. View detailed report link in comments
3. Fix issues before merging

---

## Common Issues & Solutions

### Issue 1: Coverage Report Not Found

**Problem:** "No coverage report found"

**Solution:**
```bash
# Ensure tests run before analysis
pnpm test:coverage
pnpm sonar
```

### Issue 2: Quality Gate Failed

**Problem:** Quality gate shows as failed

**Solution:**
1. Check SonarQube dashboard for specific issues
2. Fix reported code smells, bugs, or vulnerabilities
3. Increase test coverage if below 80%
4. Re-run analysis

### Issue 3: Token Authentication Failed

**Problem:** "Invalid token" error

**Solution:**
1. Verify token is correct
2. Check token has not expired
3. Ensure token has "Execute Analysis" permission
4. Regenerate token if needed

### Issue 4: Docker Container Won't Start

**Problem:** SonarQube container fails to start

**Solution:**
```bash
# Stop and remove existing container
docker stop sonarqube && docker rm sonarqube

# Increase Docker memory to 4GB minimum
# Restart with more resources
docker run -d --name sonarqube \
  -p 9000:9000 \
  -m 4g \
  -e SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true \
  sonarqube:latest
```

---

## Best Practices

### 1. Run Analysis Locally Before Push

```bash
# Before committing
pnpm test:coverage
pnpm sonar:local

# Fix any issues found
# Then commit and push
```

### 2. Keep Coverage Above 80%

- Write tests for all new features
- Don't skip test files in coverage
- Focus on critical paths first

### 3. Fix Issues Immediately

- Address all blocking issues before merge
- Review security hotspots promptly
- Refactor code smells in separate PRs if needed

### 4. Monitor Trends

- Check quality gate status weekly
- Track technical debt trend
- Monitor coverage trend

---

## Scripts Reference

```bash
# Run SonarQube with SonarCloud
pnpm sonar

# Run SonarQube with local server
pnpm sonar:local

# Run tests with coverage first
pnpm test:coverage

# Full quality check
pnpm test:coverage && pnpm sonar:local
```

---

## Links

- **SonarCloud:** https://sonarcloud.io
- **SonarQube Docs:** https://docs.sonarqube.org/latest/
- **TypeScript Plugin:** https://github.com/SonarSource/SonarTS
- **Quality Gates:** https://docs.sonarqube.org/latest/user-guide/quality-gates/

---

## Project Quality Goals

### Phase 4 Targets

| Metric | Current | Target | Status |
|--------|---------|--------|--------|
| Coverage | TBD | >80% | 🎯 Setup |
| Maintainability | TBD | A | 🎯 Setup |
| Reliability | TBD | A | 🎯 Setup |
| Security | TBD | A | 🎯 Setup |
| Duplications | TBD | <3% | 🎯 Setup |

### Post-Launch Monitoring

- Weekly quality gate reviews
- Monthly technical debt reduction sprints
- Quarterly security hotspot reviews
- Continuous coverage improvement

---

**Last Updated:** 2025-10-24
**Updated By:** Claude Code (SonarQube integration)
